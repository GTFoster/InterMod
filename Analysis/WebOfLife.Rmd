---
title: "Draft_Analysis"
author: "Your Name"
date: "2023-11-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Web of life's probably a good initial data source to test this question with. 

```{r}
library(rjson) 
library(tidyverse)
```

Quering the web of life API. 
Tutorial for how to do this found here: https://www.web-of-life.es/tutorial/session-download-data.html
```{r}
# define the base url
base_url <- "https://www.web-of-life.es/"   
json_url2 <- paste0(base_url,"get_networks.php?interaction_type=Pollination") 

WolPols <- jsonlite::fromJSON(json_url2)
length(unique(WolPols$network_name)) # 166 Networks
```

Downloading the metaData
```{r}
WolMeta <- read.csv(paste0(base_url,"get_network_info.php"))
# show results 
head(WolMeta) # %>% formattable()
colnames(WolMeta)

WolMeta <- WolMeta %>% dplyr::filter(., network_type%in%"Pollination")
length(unique(WolMeta$network_name))

table(unique(WolPols$network_name)%in%WolMeta$network_name)
table(WolMeta$region)
```

Join american networks of pollinators with their spatial metadata
```{r}
amPol <- WolMeta %>% dplyr::select(., network_name, region, latitude, longitude) %>% left_join(WolPols, ., by="network_name") %>% dplyr::filter(., region=="Americas")
```


```{r}
length(unique(amPol$network_name))
table(amPol$species1 %in% amPol$species2) 


amPlants <- amPol %>% dplyr::select(., network_name, species1) %>% unique() #All the unique plant-site combinations in us
amPollinators <- amPol %>% dplyr::select(., network_name, species2) %>% unique() #All the unique poll-site combinations in us

sum(table(rowSums(table(amPlants$species1, amPlants$network_name))))-sum(table(rowSums(table(amPlants$species1, amPlants$network_name)))[1:5])
sum(table(rowSums(table(amPollinators$species2, amPollinators$network_name))))-sum(table(rowSums(table(amPollinators$species2, amPollinators$network_name)))[1:5])
```
Out of the 166 pollination networks web of life has in the Americas, there are only 29 plant species and 63 pollinator species that occur at 6 or more sites.

Let's check out Mangal and see if we can get some more points
```{r}
library(rmangal)
```

4499	4529	
```{r eval=FALSE}
#mgs <- rmangal::search_datasets("pollinator")
#mgn <- get_collection(mgs)

nodes <- mgn[[1000]]
mgn[[1]]$interactions
mgn[[1]]$network

summary(mgn)[[1]]

#save(mgn, amPol, file="data/Mangel_Wol_Query.Rda")
```

```{r}
load("data/Mangel_Wol_Query.Rda")
```


I want to try and make a simple SDM that's trained on some aspect of community data. 

First, let's look at how many networks form Mangel have overlapping species. 
```{r}

cols <- colnames(mgn[[1]]$nodes)[1:18] #Just match the basic columns that all networks should have (extra "taxonomy" col in some to exclude, if not others)

mgnNodes <- NULL
for(i in 1:length(mgn)){
  temp <- mgn[[i]]$nodes %>% dplyr::select(., all_of(cols))
  mgnNodes <- rbind(mgnNodes, temp)
}

(length(unique(mgnNodes$network_id)))==324 #Check we actually have all the networks 
```

```{r}
MangelCounts <- mgnNodes %>% dplyr::group_by(., taxonomy.id) %>% dplyr::summarise(., networks=length(unique(network_id)))

mgnNodes$original_name[mgnNodes$taxonomy.id%in% 5038][1]
```



*Lasioglossum incompletum* is a solitary sweat bee that occurs in 136 of the reported Mangel networks. Let's find its most common partners
```{r}
LiNets <- dplyr::filter(mgnNodes, taxonomy.name=="Lasioglossum incompletum") %>% dplyr::select(., network_id) %>% unique()
```
Problem: The nodes df in the mangeldata query says *L. incompletum* should occur in network 1364, but when I actually look in that network it isn't recorded. Not sure what's up with this. 


Let's try again with the second most common species, *Halictus tripartitus*

Figured it out. A species can be recorded in a network without actually have been recorded engaging in an interaction.
```{r}
HtNets <- dplyr::filter(mgnNodes, taxonomy.name=="Halictus tripartitus") %>% dplyr::select(., network_id) %>% unique()

#These are different
x <- mgn[[8]]$interactions 
y <- mgn[[8]]$nodes
```

Node id is at the individual level, not the taxa level :(
Need to match them up

The code below does that. 
```{r}
cols <- c(colnames(mgn[[1]]$interactions)[1:6],"network_id")

mgnInt <- NULL
for(i in 1:length(mgn)){
  temp <- mgn[[i]]$interactions %>% dplyr::select(., all_of(cols))
  mgnInt <- rbind(mgnInt, temp)
}



mgnInt <- dplyr::select(mgnNodes, node_id, taxonomy.id, taxonomy.name) %>% dplyr::rename(., node_from=node_id, taxonomy.id.from=taxonomy.id, taxonomy.name.from=taxonomy.name) %>% left_join(mgnInt, ., by="node_from") #Adding the node_from taxa ID

mgnInt <- dplyr::select(mgnNodes, node_id, taxonomy.id, taxonomy.name) %>% dplyr::rename(., node_to=node_id, taxonomy.id.to=taxonomy.id, taxonomy.name.to=taxonomy.name) %>% left_join(mgnInt, ., by="node_to") #Adding the node_from taxa ID

mgnInt$InterID <- paste(mgnInt$taxonomy.id.from, mgnInt$taxonomy.id.to, sep="-") #Make a column identifying unique from-to combinations
```

Now la
```{r}
mgIntTaxaFil <- mgnInt %>% dplyr::filter(., grepl("NA", InterID)==FALSE)

InterMangelCounts <- mgIntTaxaFil %>% dplyr::group_by(., InterID) %>% dplyr::summarise(., networks=length(unique(network_id)))
```

Most common interaction, a morning glory called field bindweed (*Convolvulus arvensis*) and a sweat bee (*Lasioglossum incompletum*). This occurs in 103 networks. 

#############################################################################################3
START HERE: The above chunk and below ones don't agree. Figure it out bud

```{r}
length(unique(mgIntTaxaFil$network_id[mgIntTaxaFil$taxonomy.id.to==5038 & mgIntTaxaFil$taxonomy.id.from!=5031])) #Number of networks including the bee but don't include the morning glory

length(unique(mgIntTaxaFil$network_id[mgIntTaxaFil$taxonomy.id.from==5031 & mgIntTaxaFil$taxonomy.id.to!=5038])) #Number of networks including the morning glory but not the bee
```


############################################################## START HERE:
Make a simple model

```{r}
LasI <- mgIntTaxaFil %>% dplyr::filter(., taxonomy.name.from=="Lasioglossum incompletum" | taxonomy.name.to == "Lasioglossum incompletum") #Some data sources flop the to and from, so need to filter by both
length(unique(LasI$network_id))

ConA <- mgIntTaxaFil %>% dplyr::filter(., taxonomy.name.from=="Convolvulus arvensis" | taxonomy.name.to == "Convolvulus arvensis")
length(unique(ConA$network_id))
```

From the mangal vignette; querying the spatial data of the datasets. 
```{r}
library(sf)
library(mapview)
# assuming sf and mapview are is loaded (as we did above)
mg_poll_sf <- search_datasets(query = 'pollinator') %>% get_collection(as_sf = TRUE)
class(mg_poll_sf[[1]]$network)
#> [1] "sf"         "data.frame"
```


```{r}
spatialIDs <- NULL
for(i in 1:length(mg_poll_sf)){
  spatialIDs <- rbind(spatialIDs, mg_poll_sf[[i]]$network$network_id)
}

```

Turns out, I was missing geographic coordinates for the species described above. Let's try again, maknig a big datasource I can use for all species. 
```{r}
geoms <- list()
for(i in 1:length(mg_poll_sf)){
  #if(mg_poll_sf[[i]]$network$network_id %in% unique(ConA$network_id)==TRUE){
    #print("True")
    geoms[[i]] <-list(netID=mg_poll_sf[[i]]$network,
                      geom=mg_poll_sf[[i]]$network$geom)
    #geoms[[i]]$netID <- mg_poll_sf[[i]]$network$network_id
    #geoms[[i]]$geom <- mg_poll_sf[[i]]$network$geom
}
  #else{
    #geoms[[i]] <- "not present"
    #next
  #}
#}
```

```{r}
library(rnaturalearth)
library(rnaturalearthdata)

world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) +
    geom_sf()+theme_classic() +geom_sf(data=geoms[[228]]$geom)
for(i in 1:50){
  wrd <- wrd+geom_sf(data=geoms[[i]]$netID$geom)
}

geoms[[i]]$netID$geom
```
crds of spatvec object

```{r}
for(i in 1:324){
  if(geoms[[i]]$netID$network_id==5016){
    print(i)
  }
}
geoms[[228]]$geom
st_coordinates(geoms[[228]]$geom)

coords <- NULL
for(i in 1:length(geoms)){
df_temp <- data.frame(network_id=geoms[[i]]$netID$network_id,x=colMeans(st_coordinates(geoms[[i]]$netID$geom))[1], y=colMeans(st_coordinates(geoms[[i]]$netID$geom))[2]) #Extract the average point. If it's a polygon, average all the edge points. Will replace this with a formal centroid finding approach later
coords <- rbind(coords, df_temp)
}

coords <- dplyr::filter(coords, is.na(x)==FALSE)

```

```{r}
mGDat <- left_join(mgIntTaxaFil, coords, by="network_id")
```


```{r}
mGDat <- dplyr::filter(mGDat, is.na(x)==FALSE)
dplyr::select(mGDat, network_id, x) %>% unique() %>% table() %>% table() #Checking that there are no locations that are the same across network ids. 
```
Most records
```{r}
head(sort(table(mGDat$taxonomy.name.from), decreasing = TRUE))
head(sort(table(mGDat$taxonomy.name.to), decreasing = TRUE))

```

Most unique locations observed
```{r}
mGDat %>% dplyr::select(., taxonomy.name.from, x,y) %>% unique() %>% select(taxonomy.name.from) %>% table() %>% sort(., decreasing=TRUE) %>% head()
mGDat %>% dplyr::select(., taxonomy.name.to, network_id) %>% unique() %>% select(taxonomy.name.to) %>% table() %>% sort(., decreasing=TRUE) %>% head()
```

```{r}
partners <- mGDat %>% dplyr::filter(taxonomy.name.from=="Mordellistena pumila") %>% select(., taxonomy.name.to, network_id) %>% unique() %>% select(., taxonomy.name.to) %>% table()

sort(partners, decreasing=TRUE)
```

#Result: 
```{r}
library(ENMTML)
```

Creating occurance data files to use
```{r}
M_dat <- mGDat %>% dplyr::filter(taxonomy.name.from=="Mordellistena pumila") %>% dplyr::select(., taxonomy.name.from, x, y) %>% unique()
colnames(M_dat) <- c("sp", "x", "y")

D_dat <- mGDat %>% dplyr::filter(taxonomy.name.to=="Daucus carota carota") %>% dplyr::select(., taxonomy.name.to, x, y) %>% unique()
colnames(D_dat) <- c("sp", "x", "y")

Int_dat <- mGDat %>% dplyr::filter(taxonomy.name.to=="Daucus carota carota") %>%
  dplyr::filter(., taxonomy.name.from=="Mordellistena pumila") %>% dplyr::select(., taxonomy.name.from, x, y) %>% unique()
colnames(Int_dat) <- c("sp", "x", "y")
Int_dat$species <- "Interaction"


write.table(D_dat, file="data/occ_Dat/Dcarota.txt", sep="\t")
write.table(M_dat, file="data/occ_Dat/Mpumila.txt", sep="\t")
write.table(Int_dat, file="data/occ_Dat/Int_Dcarota.Mpumila.txt", sep="\t")
```


Reading in environmental data

```{r}
library(geodata)

bioclim_spain <- geodata::worldclim_country(country="Spain", var = "bio",res = 0.5, path = "data/")
```


```{r}
Carrot <- ENMTML(pred_dir="data/wc2.1_country/",
        proj_dir = NULL,
        result_dir = NULL,
       occ_file = "data/occ_Dat/Dcarota.txt",
       sp="sp",
       x="x",
       y="y",
       min_occ=5,
       thin_occ=NULL,
       eval_occ=NULL,
        colin_var = c(method='PCA'),
      imp_var = TRUE,
      sp_accessible_area = NULL,
       pseudoabs_method=c(method='GEO_CONST', width='100'), #100 km buffer is what cleber does
        pres_abs_ratio = 0.5,
        part=c(method= 'KFOLD', folds='2'), #Kfolds valifation, where K=5
        save_part = FALSE,
      save_final = TRUE,
      algorithm="MXD", #Using Maxent with Default Params
       thr="MAX_TSS",#Threshold by maximizing TSS
      msdm = NULL,
      ensemble = NULL,
      extrapolation = FALSE,
       cores = 4)
```


```{r}
Evaltab <- read.table(file="data/Result/Evaluation_Table.txt")
read.table(file="data/Result/Occurrences_Evaluation.txt")

Carrot_raster <- raster("data/Result/EnvConstrain/Daucus_carota_carota.tif")
plot(Carrot_raster)
```

Let's try again with the bee. I thought I had like 60 carrot entires, but actually just had like 6 :(

I'm going to try it again with just the bee with a lower KFold number-it has 10 entries. 

```{r}
Mpulima <- ENMTML(pred_dir="data/wc2.1_country/",
        proj_dir = NULL,
        result_dir = NULL,
       occ_file = "data/occ_Dat/Mpumila.txt",
       sp="sp",
       x="x",
       y="y",
       min_occ=5,
       thin_occ=NULL,
       eval_occ=NULL,
        colin_var = c(method='PCA'),
      imp_var = TRUE,
      sp_accessible_area = NULL,
       pseudoabs_method=c(method='GEO_CONST', width='100'), #100 km buffer is what cleber does
        pres_abs_ratio = 0.5,
        part=c(method= 'KFOLD', folds='2'), #Kfolds valifation, where K=5
        save_part = FALSE,
      save_final = TRUE,
      algorithm="MXD", #Using Maxent with Default Params
       thr="MAX_TSS",#Threshold by maximizing TSS
      msdm = NULL,
      ensemble = NULL,
      extrapolation = FALSE,
       cores = 4)
```



```{r}
library(raster)
str_name<-'data/wc2.1_country/ESP_wc2.1_30s_bio.tif' 
imported_raster=raster(str_name)

plot(imported_raster)
points(x=D_dat$x, y=D_dat)
```



