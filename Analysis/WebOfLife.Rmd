---
title: "Draft_Analysis"
author: "Your Name"
date: "2023-11-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Web of life's probably a good initial data source to test this question with. 

```{r}
library(rjson) 
library(tidyverse)
```

Quering the web of life API. 
Tutorial for how to do this found here: https://www.web-of-life.es/tutorial/session-download-data.html
```{r}
# define the base url
base_url <- "https://www.web-of-life.es/"   
json_url2 <- paste0(base_url,"get_networks.php?interaction_type=Pollination") 

WolPols <- jsonlite::fromJSON(json_url2)
length(unique(WolPols$network_name)) # 166 Networks
```

Downloading the metaData
```{r}
WolMeta <- read.csv(paste0(base_url,"get_network_info.php"))
# show results 
head(WolMeta) # %>% formattable()
colnames(WolMeta)

WolMeta <- WolMeta %>% dplyr::filter(., network_type%in%"Pollination")
length(unique(WolMeta$network_name))

table(unique(WolPols$network_name)%in%WolMeta$network_name)
table(WolMeta$region)
```

Join american networks of pollinators with their spatial metadata
```{r}
amPol <- WolMeta %>% dplyr::select(., network_name, region, latitude, longitude) %>% left_join(WolPols, ., by="network_name") %>% dplyr::filter(., region=="Americas")
```


```{r}
length(unique(amPol$network_name))
table(amPol$species1 %in% amPol$species2) 


amPlants <- amPol %>% dplyr::select(., network_name, species1) %>% unique() #All the unique plant-site combinations in us
amPollinators <- amPol %>% dplyr::select(., network_name, species2) %>% unique() #All the unique poll-site combinations in us

sum(table(rowSums(table(amPlants$species1, amPlants$network_name))))-sum(table(rowSums(table(amPlants$species1, amPlants$network_name)))[1:5])
sum(table(rowSums(table(amPollinators$species2, amPollinators$network_name))))-sum(table(rowSums(table(amPollinators$species2, amPollinators$network_name)))[1:5])
```
Out of the 166 pollination networks web of life has in the Americas, there are only 29 plant species and 63 pollinator species that occur at 6 or more sites.

Let's check out Mangal and see if we can get some more points
```{r}
library(rmangal)
```

4499	4529	
```{r eval=FALSE}
#mgs <- rmangal::search_datasets("pollinator")
#mgn <- get_collection(mgs)

nodes <- mgn[[1000]]
mgn[[1]]$interactions
mgn[[1]]$network

summary(mgn)[[1]]

#save(mgn, amPol, file="data/Mangel_Wol_Query.Rda")
```

```{r}
load("data/Mangel_Wol_Query.Rda")
```


I want to try and make a simple SDM that's trained on some aspect of community data. 

First, let's look at how many networks form Mangel have overlapping species. 
```{r}

cols <- colnames(mgn[[1]]$nodes)[1:18] #Just match the basic columns that all networks should have (extra "taxonomy" col in some to exclude, if not others)

mgnNodes <- NULL
for(i in 1:length(mgn)){
  temp <- mgn[[i]]$nodes %>% dplyr::select(., all_of(cols))
  mgnNodes <- rbind(mgnNodes, temp)
}

(length(unique(mgnNodes$network_id)))==324 #Check we actually have all the networks 
```

```{r}
MangelCounts <- mgnNodes %>% dplyr::group_by(., taxonomy.id) %>% dplyr::summarise(., networks=length(unique(network_id)))

mgnNodes$original_name[mgnNodes$taxonomy.id%in% 5038][1]
```



*Lasioglossum incompletum* is a solitary sweat bee that occurs in 136 of the reported Mangel networks. Let's find its most common partners
```{r}
LiNets <- dplyr::filter(mgnNodes, taxonomy.name=="Lasioglossum incompletum") %>% dplyr::select(., network_id) %>% unique()
```
Problem: The nodes df in the mangeldata query says *L. incompletum* should occur in network 1364, but when I actually look in that network it isn't recorded. Not sure what's up with this. 


Let's try again with the second most common species, *Halictus tripartitus*

Figured it out. A species can be recorded in a network without actually have been recorded engaging in an interaction.
```{r}
HtNets <- dplyr::filter(mgnNodes, taxonomy.name=="Halictus tripartitus") %>% dplyr::select(., network_id) %>% unique()

#These are different
x <- mgn[[8]]$interactions 
y <- mgn[[8]]$nodes
```

Node id is at the individual level, not the taxa level :(
Need to match them up

The code below does that. 
```{r}
cols <- c(colnames(mgn[[1]]$interactions)[1:6],"network_id")

mgnInt <- NULL
for(i in 1:length(mgn)){
  temp <- mgn[[i]]$interactions %>% dplyr::select(., all_of(cols))
  mgnInt <- rbind(mgnInt, temp)
}



mgnInt <- dplyr::select(mgnNodes, node_id, taxonomy.id, taxonomy.name) %>% dplyr::rename(., node_from=node_id, taxonomy.id.from=taxonomy.id, taxonomy.name.from=taxonomy.name) %>% left_join(mgnInt, ., by="node_from") #Adding the node_from taxa ID

mgnInt <- dplyr::select(mgnNodes, node_id, taxonomy.id, taxonomy.name) %>% dplyr::rename(., node_to=node_id, taxonomy.id.to=taxonomy.id, taxonomy.name.to=taxonomy.name) %>% left_join(mgnInt, ., by="node_to") #Adding the node_from taxa ID

mgnInt$InterID <- paste(mgnInt$taxonomy.id.from, mgnInt$taxonomy.id.to, sep="-") #Make a column identifying unique from-to combinations
```

Now la
```{r}
mgIntTaxaFil <- mgnInt %>% dplyr::filter(., grepl("NA", InterID)==FALSE)

InterMangelCounts <- mgIntTaxaFil %>% dplyr::group_by(., InterID) %>% dplyr::summarise(., networks=length(unique(network_id)))

```

Most common interaction, a morning glory called field bindweed (*Convolvulus arvensis*) and a sweat bee (*Lasioglossum incompletum*). This occurs in 103 networks. 

#############################################################################################3
START HERE: The above chunk and below ones don't agree. Figure it out bud

```{r}
length(unique(mgIntTaxaFil$network_id[mgIntTaxaFil$taxonomy.id.to==5038 & mgIntTaxaFil$taxonomy.id.from!=5031])) #Number of networks including the bee but don't include the morning glory

length(unique(mgIntTaxaFil$network_id[mgIntTaxaFil$taxonomy.id.from==5031 & mgIntTaxaFil$taxonomy.id.to!=5038])) #Number of networks including the morning glory but not the bee
```


############################################################## START HERE:
Make a simple model

```{r}
LasI <- mgIntTaxaFil %>% dplyr::filter(., taxonomy.name.from=="Lasioglossum incompletum" | taxonomy.name.to == "Lasioglossum incompletum") #Some data sources flop the to and from, so need to filter by both
length(unique(LasI$network_id))

ConA <- mgIntTaxaFil %>% dplyr::filter(., taxonomy.name.from=="Convolvulus arvensis" | taxonomy.name.to == "Convolvulus arvensis")
length(unique(ConA$network_id))
```

From the mangal vignette; querying the spatial data of the datasets. 
```{r}
library(sf)
library(mapview)
# assuming sf and mapview are is loaded (as we did above)
mg_poll_sf <- search_datasets(query = 'pollinator') %>% get_collection(as_sf = TRUE)
class(mg_poll_sf[[1]]$network)
#> [1] "sf"         "data.frame"
```


```{r}
spatialIDs <- NULL
for(i in 1:length(mg_poll_sf)){
  spatialIDs <- rbind(spatialIDs, mg_poll_sf[[i]]$network$network_id)
}

```

################## START HERE: I feel like this code should extract the geometry, but it seems like its not working. Need to fix
```{r}
geoms <- list()
for(i in length(mg_poll_sf)){
  if(mg_poll_sf[[i]]$network$network_id %in% unique(ConA$network_id)==TRUE){
    print("True")
    geoms[[i]]$netID <- mg_poll_sf[[i]]$network$network_id
    geoms[[i]]$geom <- mg_poll_sf[[i]]$network$geom
    browser()
  }
  else{
    geoms[[i]] <- "not present"
    next
  }
}

geoms[[1]]
```

```{r}
library(ENMTML)
```

```{r}
ENMTML(
  pred_dir,
  proj_dir = NULL,
  result_dir = NULL,
  occ_file,
  sp,
  x,
  y,
  min_occ = 10,
  thin_occ = NULL,
  eval_occ = NULL,
  colin_var = NULL,
  imp_var = FALSE,
  sp_accessible_area = NULL,
  pseudoabs_method,
  pres_abs_ratio = 1,
  part,
  save_part = FALSE,
  save_final = TRUE,
  algorithm,
  thr,
  msdm = NULL,
  ensemble = NULL,
  extrapolation = FALSE,
  cores = 1
)
```

